<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>Receptdatabsen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="/hourglass_loader.css" rel="stylesheet">
  <link href="/fonts.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
  <script src="/main.js"></script>

  <style>
    .CodeMirror-scroll {
      /*
       * Hack to remove the ugly extra white-space "lip" at bottom of MDE editors
       */
      /*
      * padding-bottom: 5px !important; // original value: 30px
      * margin-bottom: -55px !important; // original value -30px
      */
    }

    .editor-toolbar {
      border-top-left-radius: 2px;
      border-top-right-radius: 2px;
    }
    .CodeMirror {
      border-bottom-left-radius: 2px;
      border-bottom-right-radius: 2px;
    }
  </style>

</head>

<body>
  <div id="elm"></div>

  <script type="text/javascript">
    const flags = {width: window.innerWidth, height: window.innerHeight}
    const app = Elm.Main.init({
      node: document.getElementById('elm'),
      flags: flags
    })

    class EasyMDEditor extends HTMLElement {
      constructor() {
        super()
      }

      connectedCallback() {
        console.log("connectedCallback", this.getAttribute("id"))

        const textArea = document.createElement('textarea')
        this.appendChild(textArea)
        const id = this.getAttribute("id")

        let options = this.getAttribute("options")
        if (options) {
          options = JSON.parse(options)
        }
        options = Object.assign({toolbar: null}, options)

        const easyMDE = new EasyMDE({
          element:  textArea,
          toolbar: options["toolbar"],
          spellChecker: false,
          placeholder: this.getAttribute("placeholder"),
          initialValue: this.getAttribute("initialValue"),
          previewRender: function(plainText, preview) {
            const msg = {
              type: "previewMarkdown",
              id: id,
              value: plainText
            }
            app.ports.portReceiver.send(msg)
            setTimeout(function() {
              const md = document.getElementsByClassName("markdown-preview")[0]
              preview.innerHTML = md.innerHTML
            }, 25)
            return ""
          }
        })

        easyMDE.codemirror.on("change", () => {
          const msg = {
            type: "change",
            id: id,
            value: easyMDE.value()
          }
          app.ports.portReceiver.send(msg)
        })

        easyMDE.codemirror.on("blur", () => {
          const msg = {
            type: "blur",
            id: id
          }
          app.ports.portReceiver.send(msg)
        })
      }

      static get observedAttributes() {
        return ["initialValue"]
      }

      attributeChangedCallback(name, oldValue, newValue) {
        console.log('Custom element attributes changed.');
      }
    }

    customElements.define('easy-mde', EasyMDEditor)

    app.ports.portSender.subscribe(function(elmValue) {
      console.log("elmValue", elmValue)
    })

  </script>
</body>
</html>
